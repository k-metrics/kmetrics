---
title: "R Basics, ggplot2"
output:
  learnr::tutorial:
    df_print: "paged"
    highlight: textmate
    md_extensions: -ascii_identifiers
runtime: shiny_prerendered
description: > 
  『ggplot2のすゝめ』：データ分析勉強会の初学者向け講義資料を再構成し対話型チュートリアル化しました。
---

```{r setup, include=FALSE}
# 共通chunkオプションの指定
knitr::opts_chunk$set(warning = FALSE, echo = TRUE)
htmltools::tagList(rmarkdown::html_dependency_font_awesome())

# 表示で利用する外部パッケージの読み込み
require(gridExtra)
require(DT)
require(knitr)

# データハンドリングで利用する外部パッケージの読み込み
require(learnr)
require(tidyverse)

# ローカル定義関数の読み込み
# source("./shared/common.R", encoding = "UTF-8")
```


## はじめに
本チュートリアルはデータ分析勉強会の初学者向け講義で使用した『ggplot2 のすゝめ』を再構成し、対話型チュートリアル化したものです。  
　

### Rのグラフにおける課題
Rのデフォルトグラフ描画関数は便利ですが、パラメータの指定方法が統一されていないなど初学者にとっては分かりにくい点があります。また、描画がシンプル過ぎて今時のレポートでは見栄えしにくいという面もあります。
```{r, echo=FALSE}
iris %>% 
  with(plot(Petal.Width, Petal.Length))
```

　  

### Package ggplot2
`ggplot2`パッケージは上記のような課題を解決するためにグラフ描画に関わる文法の統一とエレガントな体裁を提供してくれます。例えば上の散布図を`ggplot2`パッケージで描くと
```{r, echo=FALSE}
iris %>% 
  ggplot2::ggplot(ggplot2::aes(x = Petal.Width, y = Petal.Length)) + 
    ggplot2::geom_point(ggplot2::aes(colour = Species))
```

では、実際にコードを実行しながら`ggplot2`パッケージの基本的な使い方を学びましょう。

　  

### チュートリアルの使い方 {.tabset}
演習では説明の後にコードが実行できるチュートリアルエリアが表示されます。  

1. 設問にしたがい必要に応じてコードを記述する
    * 改行すれば行は自動的に追加される
1. `[Run Code]`ボタンをクリックしてコードを実行する
    * コードを実行すると学習記録が保存される（演習タイトルにチェックマークが付く）
    * エラーが表示された場合はコードを修正して再実行する
1. 記述するコードが分からない場合には`[Hint]`ボタンをクリックする
    * ヒントに記載されているコードをコピーするには`[Copy to Clipboard]`ボタンをクリックする
    * コードをペーストするにはキーボードの`[CtrL]+[v]`を押下する
1. 最初からやり直す場合は`[Satrt Over]`ボタンをクリックする
1. 学習記録をクリアする場合は左側のメニュー最下部にある`[Start Over]`をクリックする

　  

#### 設問
1. `iris`データセットを表示するコードを記述して実行しなさい
    * コードが分からない場合は`[HInt]`ボタンをクリックしなさい
1. `iris`データセットが表示されたら`[解説]`タブをクリックしなさい 

```{r tutorial-example, exercise=TRUE}
# Write R code here
```

```{r tutorial-example-hint, exercise=FALSE}
# Hint
iris
```


#### 解説
* 解説がある場合にはタブ形式で表示します（解説がない演習もあります）
1. `[Tips]`タブをクリックしなさい

```{r}
head(iris)
```


#### Tips
* ちょっと便利な使い方や知っておくと役立つ情報がある場合はタブで表示します（Tipsがない演習もあります）


### Let's Start
では、`[Next Topic]`ボタンをクリックしてチュートリアルを始めましょう。



## 描画の基本
`ggplot2`パッケージは`tidyverse`パッケージ・ファミリーですので、`dplyr`パッケージや`tidyr`パッケージとの親和性が高く、データフレーム型を入力データとしています。また、描画のための統一的な文法が定義されており様々なグラフを以下のような手順で描くことができます。  

1. 描画対象となるデータを指定する
1. 描くグラフの座標軸になる変数を指定する
1. 描くフラフを指定する

では、手順をなぞりながらコードを実行してみます。


### 0. パッケージの読み込み
本チュートリアルでは実行不要ですが、実際に`ggplot2`パッケージを利用する際には最初に下記のコードを実行し必要なパッケージを読み込んでおきます。
```{r}
library(tidyverse)
```


### 1. 描画対象となるデータを指定 {.tabset}
描画対象として三種類のアヤメの花弁と萼片の測定結果がまとめらえている`iris`データセットを用います。`ggplot2`パッケージが扱える（`ggplot2`の関数へ入力できる）データは**データフレーム型**のみです。

#### 設問
1. `[Run Code]`をクリックして描画対象となるデータを確認しなさい

```{r step-1, exercise=TRUE}
iris
```


### 2. 描くグラフの座標軸になる変数を指定 {.tabset}
横軸（$X$軸）に萼片（Sepal）の幅（Width）、縦軸（$Y$軸）に萼片（Sepal）の長さ（Lenrth）を指定します。この処理でグラフ用紙が用意されるとイメージしてください。

#### 設問
1. `[Run Code]`をクリックして結果を確認しなさい

```{r step-2, exercise=TRUE}
iris %>% 
  ggplot2::ggplot(ggplot2::aes(x = Sepal.Width, y = Sepal.Length))
```

#### 解説
`ggplot2::aes`関数はグラフの座標などを指定するための関数（エステティック関数）です。指定した変量がとる値の範囲（下表参照）から適切な目盛りのグラフ用紙（グラフ座標）を作成してくれます。
```{r, echo=FALSE}
iris %>% 
  dplyr::summarise(Sepal.Wddth = range(Sepal.Width), Sepal.Length = range(Sepal.Length))
```

#### Tisp
`ggplot2::aes`関数は座標だけでなく、色やグルーピング（層別）などの指定もできます。詳細については、後ほど説明します。
```{r, eval=FALSE}
# Usage
ggplot2::aes(x, y, ...)
```



### 3. 描くフラフを指定 {.tabset}
最後に`ggplot2::geom_point`関数を用いて散布図を描きます。

#### 設問
1. `[Run Code]`をクリックして結果を確認しなさい

```{r step-3, exercise=TRUE}
iris %>% 
  ggplot2::ggplot(ggplot2::aes(x = Sepal.Width, y = Sepal.Length)) +
    ggplot2::geom_point()
```


#### 解説
`geom_point`関数を別のグラフ関数に置き換えることで様々なグラフが描けます。ただし、グラフにより横軸・縦軸の取る変量が異なりますので合わせてエステティック関数での指定を変更する必要はあります。


### 描画の基本（箱ひげ図） {.tabset}
先程は二変量の関係を知るために有用な散布図を描きましたが、同じデータを使って一変量の値の分布を把握したり比較するのに便利な箱ひげ図を描きます。  

箱ひげ図は名義尺度もしくは順序尺度の変量を横軸に、縦軸には間隔尺度や比例尺度など数値のデータを指定します。


#### 設問
1. `iris`データセットを用いて
1. 横軸に`Species`（品種）、縦軸に`Sepal.Length`（萼片の長さ）を指定し
1. 箱ひげ図（`geom_boxplot`）を描きなさい

```{r draw-boxplot, exercise=TRUE}
 %>% 
  ggplot2::ggplot(ggplot2::aes(x = , y = )) +
    ggplot2::geom_()
```

```{r draw-boxplot-hint}
iris %>% 
  ggplot2::ggplot(ggplot2::aes(x = Species, y = Sepal.Length)) +
    ggplot2::geom_boxplot()
```


#### 解説
基本は散布図を描く場合と同じです。


### まとめ
`ggplot2`パッケージはデジタル地図で使われているレイヤー構造のように描画対象を順番に指定することにより様々なグラフを描くことができます。まずは、この基本を身につけましょう。



## 様々なグラフ
ソフトウェアメトリクス分析でよく使われるグラフを描いてみます。


### ヒストグラム {.tabset}
箱ひげ図とならんで変量がとる値の分布を見るのがヒストグラムです。ヒストグラムを描くには`geom_histgram`関数を用います。

#### 設問
1. `iris`データセットを用いて
1. `Sepal.Width`（萼片の幅）のヒストグラムを描きなさい

```{r draw-histgram, exercise=TRUE}
iris %>% 
  ggplot2::ggplot(ggplot2::aes(x = Sepal.Width)) + 
    ggplot2::geom_histogram()
```

```{r draw-histgram-hint}
iris %>% 
  ggplot2::ggplot(ggplot2::aes(x = Sepal.Width)) + 
    ggplot2::geom_histogram()
```


#### 解説
`ggplot2`で描くヒストグラムは指定された変量がとる値の範囲を$30$分割（ビン数=$30$）して描きます。階級を変更する場合は以下のオプションのどれかで指定してください。

Option   | 内容             | 備考
---------|------------------|---------------------------------------------------
bins     | ビン数（分割数） | デフォルト（bins = 30）
binwidth | 階級幅           | 
breaks   | 階級             | 等幅であれば`pretty`関数を使って計算したものを指定します


#### Tips
`histgram`関数のようにスタージェスの公式に基づく階級を指定する場合は`pretty`関数を使って以下のように指定します。
```{r}
breaks <- with(iris, pretty(Sepal.Width, nclass.Sturges(Sepal.Width)))

iris %>% 
  ggplot2::ggplot(ggplot2::aes(x = Sepal.Width)) + 
    ggplot2::geom_histogram(breaks = breaks)
```


### 回帰図 {.tabset}
（単）回帰分析では必ず出てくる回帰図は散布図と回帰直線を組み合わせることで描きます。回帰直線は`geom_smooth`関数に`mothod = "lm"`オプションを指定します。


#### 設問
1. `iris`データセットを用いて
1. 横軸に`Petal.Width`（花弁の幅）、縦軸に`Petal.Length`（花弁の長さ）を指定し
1. 散布図（`geom_point`）を描き
1. 回帰直線（`geom_smooth`）を描きなさい

```{r draw-lm, exercise=TRUE}
 %>% 
  ggplot2::ggplot(ggplot2::aes(x = , y = )) + 
    ggplot2::geom_ + 
    ggplot2::geom_
```

```{r draw-lm-hint}
iris %>% 
  ggplot2::ggplot(ggplot2::aes(x = Petal.Width, y = Petal.Length)) + 
    ggplot2::geom_point() + 
    ggplot2::geom_smooth(method = "lm")
```


#### 解説
`ggplot2`パッケージでは座標が同じ場合は簡単にグラフを重ねることができます。回帰直線にあるグレーのエリアは$95%$信頼区間です。信頼区間を描きたくない場合は`se = FALSE`オプションを指定してください。その他のオプションについてはヘルプを参照してください。


### 折線グラフ {.tabset}
折線グラフは時系列グラフに代表されるように横軸の値に順序関係がある順序尺度や間隔尺度を利用する場合に使われます。折線グラフを描くには`geom_line`関数を使います。  
この演習では1973年5月〜9月のニューヨークにおける日次の大気観測データ（`airqualirty`データセット）を用います。
```{r}
airquality
```


#### 設問
1. `ariquarity`データセットを用いて
1. $5$月のデータを用いて
1. 温度（`Temp`）の日毎の変化を折線グラフとして描きなさい。

```{r draw-line, exercise=TRUE}
 %>% 
  dplyr::filter(Month == ) %>% 
  ggplot2::ggplot(ggplot2::aes(x = Day, y = )) + 
    ggplot2::geom_
```

```{r draw-line-hint}
airquality %>% 
  dplyr::filter(Month == 5) %>% 
  ggplot2::ggplot(ggplot2::aes(x = Day, y = Temp)) + 
    ggplot2::geom_line()
```


#### 解説1
`geom_line`関数は欠損値（欠測値、`NA`）がある場合、欠損値の部分に関しては折線を描画しません。
```{r}
airquality %>% 
  dplyr::filter(Month == 7) %>% 
  ggplot2::ggplot(ggplot2::aes(x = Day, y = Ozone)) + 
    ggplot2::geom_line()
```

#### 解説2
横軸（`x`）に指定する変量に同値があった場合は出現順に複数の折線がプロットされますので横軸（`x`）に指定する変量が取る値はユニークであることを確認してください。
```{r}
airquality %>% 
  ggplot2::ggplot(ggplot2::aes(x = Day, y = Ozone)) + 
    ggplot2::geom_line()
```


#### Tips
時系列データの分析を行う場合には時系列クラス（Time Serise、`ts`クラス）を用いてプロットした方が適している場合もあります。目的に応じて使い分けてください。
```{r}
airquality %>% 
  dplyr::select(-Month, -Day) %>% 
  ts() %>% plot(main = "tsクラスによる時系列プロット")
```







### ドットチャート {.tabset}

#### 設問

```{r}
iris %>% 
  ggplot2::ggplot(ggplot2::aes(x = Species, y = Sepal.Length)) + 
    ggplot2::geom_jitter()
    # ggplot2::geom_dotplot(binaxis = "y", stackdir = "center")
```


#### 解説

#### Tips



## 様々な描画オプション

### タイトルをつける {.tabset}

#### 設問
1. タイトル「アヤメ萼片の幅と長さの関係」を追加しなさい

```{r add-main-title, exercise=TRUE, exercise.lines=6}
iris %>% 
  ggplot2::ggplot(ggplot2::aes(x = Sepal.Width, y = Sepal.Length)) +
    ggplot2::geom_point()

```

```{r add-main-title-hint}
iris %>% 
  ggplot2::ggplot(ggplot2::aes(x = Sepal.Width, y = Sepal.Length)) +
    ggplot2::geom_point() +
    ggplot2::ggtitle("アヤメ萼片の幅と長さの関係")
```

#### 解説
`ggtitle`関数はタイトルとサブタイトルを指定するための関数です。書式は至ってシンプルです。タイトルオプションを明示的にしていする際は`label`で指定することに注意してください。
```{r}
iris %>% 
  ggplot2::ggplot(ggplot2::aes(x = Sepal.Width, y = Sepal.Length)) +
    ggplot2::geom_point() +
    ggplot2::ggtitle(label = "アヤメ萼片の幅と長さの関係", subtitle = "Fisher's Iris")
```


### 座標軸ラベルを変更する {.tabset}
座標軸のデフォルトラベルは`ggplot2::aes`関数で指定した変量名が使われます。座標軸のラベルを変更するには`xlab`関数と`ylab`関数を用います。

#### 設問
1. `iris`データセットを用いて
1. 横軸に萼片幅（`Sepal.Width`）、縦軸に萼片長（`Sepal.Length`）を指定し
1. 散布図（`geom_point`）を描き
1. 軸ラベルを「萼片幅」と「萼片長」に直しなさい

```{r update-axis-label, exercise=TRUE, exercise.lines=6}
 %>% 
  ggplot2::ggplot(ggplot2::aes(x = , y = )) +
    ggplot2::geom_ +
    ggplot2::xlab(label = "萼片幅") + ggplot2::ylab(label = "萼片長")
```

```{r update-axis-label-hint}
iris %>% 
  ggplot2::ggplot(ggplot2::aes(x = Sepal.Width, y = Sepal.Length)) +
    ggplot2::geom_point() +
    ggplot2::xlab(label = "萼片幅") + ggplot2::ylab(label = "萼片長")
```


### タイトルと座標軸ラベルを同時に指定する
`labs`関数を使うと一つの関数でタイトルや座標軸ラベルなど複数の指定が可能です。
```{r}
iris %>% 
  ggplot2::ggplot(ggplot2::aes(x = Sepal.Width, y = Sepal.Length)) +
    ggplot2::geom_point() +
    ggplot2::labs(title = "アヤメ萼片の幅と長さの関係",
                  subtitle = "Fisher's Iris",
                  x = "萼片幅", y = "萼片長", 
                  caption = "CAPTION", tag = "TAG")
```


### グラフスタイルを変える {.tabset}
`ggplot2`のデフォルトグラフスタイルが好みに合わない場合は`ggplot2::theme_`関数群で変更することができます。適用したいテーマの関数を下記のように指定するだけです。デフォルトテーマ（`theme_gray`）を除き$8$種類のテーマが用意されています。
```{r, eval=FALSE}
iris %>% 
  ggplot2::ggplot(aes(x = Sepal.Width, y = Sepal.Length)) +
    ggplot2::geom_point() + ggplot2::xlab("") + ggplot2::ylab("") + 
    ggplot2::theme_*()
```

```{r, echo=FALSE}
gg <- iris %>% 
  ggplot2::ggplot(aes(x = Sepal.Width, y = Sepal.Length)) +
    ggplot2::geom_point() + ggplot2::xlab("") + ggplot2::ylab("")

gg_bw <- gg + ggplot2::theme_bw() + ggplot2::ggtitle("theme_bw")
gg_ld <- gg + ggplot2::theme_linedraw() + ggplot2::ggtitle("theme_linedraw")
gg_lt <- gg + ggplot2::theme_light() + ggplot2::ggtitle("theme_light")
gg_dr <- gg + ggplot2::theme_dark() + ggplot2::ggtitle("theme_dark")
gg_mi <- gg + ggplot2::theme_minimal() + ggplot2::ggtitle("theme_minimal")
gg_cl <- gg + ggplot2::theme_classic() + ggplot2::ggtitle("theme_classic")
gg_vo <- gg + ggplot2::theme_void() + ggplot2::ggtitle("theme_void")
gg_ts <- gg + ggplot2::theme_test() + ggplot2::ggtitle("theme_test")
```

#### デフォルト
```{r, echo=FALSE}
gg + ggplot2::ggtitle("theme_gray or theme_grey, as default")
```

#### 例1〜2
```{r, echo=FALSE}
library(patchwork)
gg_bw + gg_ld
```

#### 例3〜4
```{r, echo=FALSE}
library(patchwork)
gg_lt + gg_dr
```

#### 例5〜6
```{r, echo=FALSE}
library(patchwork)
gg_mi + gg_cl
```

#### 例7〜8
```{r, echo=FALSE}
library(patchwork)
gg_vo + gg_ts
```

#### 設問
1. `iris`データセットを用いて、品種（`Species`）ごとに萼片長（`Sepal.Length`）の箱ひげ図を描き
1. `minimal`テーマを指定しなさい

```{r theme-draw, exercise=TRUE}
 %>% 
  ggplot2::ggplot(ggplot2::aes(x = , y = )) + 
    ggplot2:: + 
    ggplot2::
```

```{r theme-draw-hint}
iris %>% 
  ggplot2::ggplot(ggplot2::aes(x = Species, y = Sepal.Length)) + 
    ggplot2::geom_boxplot() + 
    ggplot2::theme_minimal()
```


### グラフ軸を操作する
`ggplot2`パッケージでは座標軸はエステティック関数（`aes`）が自動的に計算してくれますが、自分で変更したい場合には`coord_`関数群を使います。例えば基本的には縦方向で描画される箱ひげ図を横向きに描く場合は以下のように`coord_flip`関数を指定するだけです。
```{r}
iris %>% 
  ggplot2::ggplot(ggplot2::aes(x = Species, y = Sepal.Length)) + 
    ggplot2::geom_boxplot() + 
    ggplot2::coord_flip()
```


```{r}
iris %>% 
  ggplot2::ggplot(ggplot2::aes(x = Sepal.Width, y = Sepal.Length)) + 
    ggplot2::geom_point() + 
    ggplot2::coord_equal()
```


```{r}
iris %>% 
  ggplot2::ggplot(ggplot2::aes(x = log(Sepal.Width), y = log(Sepal.Length))) + 
    ggplot2::geom_point()

  iris %>% 
  ggplot2::ggplot(ggplot2::aes(x = Sepal.Width, y = Sepal.Length)) + 
    ggplot2::geom_point() + 
    ggplot2::coord_trans(x = "log", y = "log")
```

```{r}
iris %>% 
  ggplot2::ggplot(ggplot2::aes(x = Sepal.Width, y = Sepal.Length)) + 
    ggplot2::geom_point() +
    ggplot2::scale_x_reverse()
```


## 層別に描く

### 層別にプロットする
このままでは色気がないので品種(`Species`)毎に色分けした散布図にしてみましょう。色分けは`ggplot2::geom_point`関数内で`ggplot2::aes`関数を用いて指定します。  
```{r, eval=FALSE}
# Usage
aes(colour)
```

`colour`は米語のcolorと同じです。パッケージ作者のHadly Wickhamは英語(Queen's English)至上主義なところがあり、このような引数名になっています。  
```{r, fig.cap="Fig.散布図を色分け表示する"}
iris %>% 
  ggplot2::ggplot(ggplot2::aes(x = Sepal.Width, y = Sepal.Length)) +
    ggplot2::geom_point(aes(colour = Species)) +
    ggplot2::ggtitle("みんな大好きiris") +
    ggplot2::xlab("がく片の幅") + ggplot2::ylab("がく片の長さ")
```
　  

### 層別の回帰直線を描く
折角、色分けしてるのですから色毎（層別）に回帰直線を描きたいものです。その場合は`colour`オプションの指定を`ggplot2::geom_point`関数ではなく`ggplot2::ggplot`関数内で指定して下さい。  
```{r, fig.cap="Fig.品種で層別に回帰直線を描く"}
iris %>% 
  ggplot2::ggplot(ggplot2::aes(x = Sepal.Width, y = Sepal.Length,
                               colour = Species)) +
    ggplot2::geom_point() +
    ggplot2::ggtitle("みんな大好きiris") +
    ggplot2::xlab("がく片の幅") + ggplot2::ylab("がく片の長さ") +
    ggplot2::geom_smooth(method = "lm", se = TRUE, level = 0.95)
```

このように`ggplot2::geom_`関数に対して指定するか、座標軸を指定する`ggplot2::ggplot`に対して指定するかで、オプションの有効範囲が異なります。`ggplot2::aes`関数を用いる時は指定場所に留意して下さい。  
　  

### 層別の折線グラフ

```{r}
airquality %>% 
  dplyr::mutate(Month = as.factor(Month)) %>% 
  ggplot2::ggplot(ggplot2::aes(x = Day, y = Temp, colour = Month)) + 
    ggplot2::geom_line()

airquality %>% 
  dplyr::mutate(Month = as.factor(Month)) %>% 
  ggplot2::ggplot(ggplot2::aes(x = Day, y = Ozone, colour = Month)) + 
    ggplot2::geom_line()
```






## 応用的な使い方
`ggplot2`パッケージでは更に様々なアレンジが可能です。  
　  

## サイズを変える
例えば散布図の点の大きさを変えるには`size`オプションを用います。  
```{r, fig.cap="画一的に点のサイズを指定する"}
iris %>% 
  ggplot2::ggplot(ggplot2::aes(x = Sepal.Width, y = Sepal.Length,
                               colour = Species)) + 
    ggplot2::geom_point(size = 5)
```
　  

## 変数を用いてサイズを変える
更に花弁の長さ（`Petal.Length`）に応じた点の大きさにしたい場合は`ggplot2::aes`関数の中で`size`オプションを用います。  
```{r, fig.cap="変数の値に応じて点のサイズを変える"}
iris %>% 
  ggplot2::ggplot(ggplot2::aes(x = Sepal.Width, y = Sepal.Length,
                               colour = Species)) + 
    ggplot2::geom_point(ggplot2::aes(size = Petal.Length))
```
　  

## 点を別の形に変える
色分けだけでは見難い場合には`shape`オプションを用いて丸点とは異なるシンボルマークに変更することができます。  
```{r, fig.cap="品種に応じて点の形を変える"}
iris %>% 
  ggplot2::ggplot(ggplot2::aes(x = Sepal.Width, y = Sepal.Length,
                               colour = Species)) + 
    ggplot2::geom_point(ggplot2::aes(shape = Species), size = 3)
```
　  

## ヒストグラムを描く
がく片の長さ（`Sepal.Length`）のヒストグラムを`ggplot2::geom_histgram`関数を用いて描いてみましょう。  
```{r, eval=FALSE}
# Usage
geom_histogram(mapping = NULL, data = NULL, stat = "bin", position = "stack",
               ..., binwidth = NULL, bins = NULL, na.rm = FALSE,
               show.legend = NA, inherit.aes = TRUE)
```

ヒストグラムの場合、縦軸(y軸)は度数になりますので、`ggplot2::aes`関数で`y`オプションを指定する必要はありません。`bins`オプションは横軸(x軸)の分割数ですが、階級幅の指定はヘルプを参照して適切なものを指定してください。  
```{r, fig.cap="Fig.ヒストグラム"}
iris %>% 
  ggplot2::ggplot(ggplot2::aes(x = Sepal.Length)) + 
    ggplot2::geom_histogram(bins = 20)
```
　  

## ヒストグラムを色分けする
`ggplot2::geom_histgram`関数に対する`colour`オプション指定は枠線にしか適用されません。  
```{r}
iris %>% 
  ggplot2::ggplot(aes(x = Sepal.Length, colour = Species)) + 
    ggplot2::geom_histogram(bins = 20)
```

塗りつぶしは`fill`オプションを使用する必要があります。  
```{r, fig.cap="塗りつぶす場合はfillオプションで"}
iris %>% 
  ggplot2::ggplot(ggplot2::aes(x = Sepal.Length, fill = Species)) + 
    ggplot2::geom_histogram(bins = 20)
```
　  

## 色の透過度を変える
塗りつぶし色は、結構、どぎつい傾向がありますのでの透過度(アルファチャネル)を用いて変更した方がきれいなことがあります。`alpha`オプションを指定してください。  
```{r}
iris %>% 
  ggplot2::ggplot(ggplot2::aes(x = Sepal.Length, fill = Species)) + 
    ggplot2::geom_histogram(bins = 20, alpha = 0.5)
```
　  

## ヒストグラムを重ねて描く
`ggplot2::geom_histgram`関数がデフォルトで描く層別ヒストグラムは積上げグラフになっています。層別で独立したヒストグラムを描く場合には`position`オプションを指定してください。  
```{r, fig.cap="Fig.品種で層別した重ね合わせヒストグラム"}
iris %>% 
  ggplot2::ggplot(ggplot2::aes(x = Sepal.Length, fill = Species)) + 
    ggplot2::geom_histogram(bins = 20, alpha = 0.5, position = "identity")
```

上図では今ひとつ分かりにくいかも知れませんが、下図の三つのグラフが重ね合わされて描かれており重なっている部分の色が濃くなっているのが分かるかと思います。  
```{r, echo=FALSE, fig.height=3, fig.width=7}
iris %>% 
  ggplot2::ggplot(ggplot2::aes(x = Sepal.Length, fill = Species)) + 
    ggplot2::geom_histogram(bins = 20, alpha = 0.5) +
    ggplot2::facet_wrap(~ Species)
```
　  

## 密度関数を上書きする
ヒストグラムを描く場合、密度関数も同時に描きたい場合があります。密度関数は`ggplot2::geom_density`関数で描けます。  
```{r, eval=FALSE}
# Usage
geom_density(mapping = NULL, data = NULL, stat = "density",
             position = "identity", ..., na.rm = FALSE, show.legend = NA,
             inherit.aes = TRUE)
```

ただし、ヒストグラムに重ね合わせる場合は注意が必要です。`y`オプションとして`y = ..density..`を必ず指定してください。これは`ggplot2::stat_`関数群で計算された値をｙ軸に重ね合わせるために必要な指定です。詳細は省きますので、詳しく知りたい場合は「generated variables」で検索してみてください。なお`ggplot2::geom_density`関数における`size`オプションは線の太さを指定するのに用います。  
```{r, fig.cap="密度関数を重ねると縦軸は密度になる点に注意"}
iris %>% 
  ggplot2::ggplot(ggplot2::aes(x = Sepal.Length, y = ..density..,
                               fill = Species)) + 
    ggplot2::geom_histogram(bins = 20, alpha = 0.5, position = "identity") + 
    ggplot2::geom_density(alpha = 0.25, size = 0.1)
```
　  

## 箱ひげ図を描く
箱ひげ図を描くには`ggplot2::geom_boxplot`関数を用います。`ggplot2::geom_boxplot`を層別で使わない場合はｘ軸に適当な値を指定してください。  
```{r, eval=FALSE}
geom_boxplot(mapping = NULL, data = NULL, stat = "boxplot",
             position = "dodge", ..., outlier.colour = NULL,
             outlier.color = NULL, outlier.fill = NULL, outlier.shape = 19,
             outlier.size = 1.5, outlier.stroke = 0.5, outlier.alpha = NULL,
             notch = FALSE, notchwidth = 0.5, varwidth = FALSE, na.rm = FALSE,
             show.legend = NA, inherit.aes = TRUE)
```

この場合はｘ軸に`NA`を指定しています。必要に応じて`ggplot2::xlab`関数などを用いてｘ軸のラベル表示を変更してください。  
```{r, fig.cap="箱ひげ図"}
iris %>% 
  ggplot2::ggplot(ggplot2::aes(x = NA, y = Sepal.Length)) + 
    ggplot2::geom_boxplot()
```
　  

## 箱ひげ図を層別で描く
`ggplot2::geom_boxplot`関数はで層別の箱ひげ図を描く場合は`x`オプションに層別変数を指定してください。  
```{r, fig.cap="品種毎の層別箱ひげ図"}
iris %>% 
  ggplot2::ggplot(ggplot2::aes(x = Species, y = Sepal.Length)) + 
    ggplot2::geom_boxplot()
```
　  

## 箱ひげ図を色分けする
箱ひげ図を色分けするには二つの方法があります。描画線で色分けする場合は散布図の場合と同じく`colour`オプションで指定します。  
```{r}
iris %>% 
  ggplot2::ggplot(ggplot2::aes(x = Species, y = Sepal.Length)) + 
    ggplot2::geom_boxplot(ggplot2::aes(colour = Species))
```

塗りつぶしで色分けする場合はヒストグラムの場合と同じく`fill`オプションで指定します。  
```{r}
iris %>% 
  ggplot2::ggplot(ggplot2::aes(x = Species, y = Sepal.Length)) + 
    ggplot2::geom_boxplot(ggplot2::aes(fill = Species), alpha = 0.5)
```

もちろん`colour`と`fill`を同時に指定することも可能です。
```{r}
iris %>% 
  ggplot2::ggplot(ggplot2::aes(x = Species, y = Sepal.Length)) + 
    ggplot2::geom_boxplot(ggplot2::aes(colour = Species, fill = Species),
                          alpha = 0.5)
```
　  

## 箱ひげ図にデータを重ねる
箱ひげ図だけではデータの分布傾向が分かりませんので`ggplot2::geom_jitter`関数を用いデータを重ねて描画すると分かりやすくなる場合があります。  
```{r, eval=FALSE}
# Usage
geom_jitter(mapping = NULL, data = NULL, stat = "identity",
            position = "jitter", ..., width = NULL, height = NULL,
            na.rm = FALSE, show.legend = NA, inherit.aes = TRUE)
```

当然、層別による色分けも可能です。  
```{r}
iris %>% 
  ggplot2::ggplot(ggplot2::aes(x = Species, y = Sepal.Length)) + 
    ggplot2::geom_boxplot(ggplot2::aes(colour = Species)) + 
    ggplot2::geom_jitter(ggplot2::aes(colour = Species))
```
　  

## バイオリンプロット
`ggplot2::geom_violin`によるバイオリンプロットを使うとデータの分布を更に視覚的に把握しやすくなる場合があります。  
```{r, eval=FALSE}
# Usage
geom_violin(mapping = NULL, data = NULL, stat = "ydensity",
            position = "dodge", ..., draw_quantiles = NULL, trim = TRUE,
            scale = "area", na.rm = FALSE, show.legend = NA, inherit.aes = TRUE)
```

バイオリンプロットも箱ひげ図同様に描画線と塗りつぶし色を指定することが可能です。  
```{r}
iris %>% 
  ggplot2::ggplot(ggplot2::aes(x = Species, y = Sepal.Length)) + 
    ggplot2::geom_violin(ggplot2::aes(colour = Species, fill = Species),
                         alpha = 0.2)
```
　  


## テキストラベルをつける
個々のデータにテキストラベルを付与することも可能ですが、データ数が多かったりデータの値が近接していたりすると逆に見難くなってしまうというデメリットもあります。テキストやラベルを表示するには`ggplot2::geom_text`関数または`ggplot2::geom_label`関数を用います。  
```{r, eval=FALSE}
# Usage
geom_label(mapping = NULL, data = NULL, stat = "identity",
           position = "identity", ..., parse = FALSE, nudge_x = 0, nudge_y = 0,
           label.padding = unit(0.25, "lines"), label.r = unit(0.15, "lines"),
           label.size = 0.25, na.rm = FALSE, show.legend = NA,
           inherit.aes = TRUE)

geom_text(mapping = NULL, data = NULL, stat = "identity",
          position = "identity", ..., parse = FALSE, nudge_x = 0, nudge_y = 0,
          check_overlap = FALSE, na.rm = FALSE, show.legend = NA,
          inherit.aes = TRUE)
```

```{r}
mtcars %>% 
  ggplot2::ggplot(ggplot2::aes(x = wt, y = mpg)) +
    ggplot2::geom_point() + 
    ggplot2::geom_smooth(method = "lm") +
    ggplot2::geom_text(ggplot2::aes(label = row.names(mtcars), colour = cyl), 
                       hjust = "inward", vjust = "inward")
```
　  

## 統計情報で描く
平均値とその標準誤差を計算し、平均値を棒グラフで描き、標準誤差をエラーバーで表示するということも`ggplot2::stat_summary`関数を利用することで実現可能です。  
```{r, eval=FALSE}
# Usage
stat_summary(mapping = NULL, data = NULL, geom = "pointrange",
             position = "identity", ..., fun.data = NULL, fun.y = NULL,
             fun.ymax = NULL, fun.ymin = NULL, fun.args = list(), na.rm = FALSE,
             show.legend = NA, inherit.aes = TRUE)
```

```{r}
iris %>% 
  ggplot2::ggplot(ggplot2::aes(x = Species, y = Petal.Length,
                               fill = Species)) + 
    ggplot2::stat_summary(fun.y = mean, geom = "bar", alpha = 0.5) +
    ggplot2::stat_summary(fun.data = mean_cl_normal, geom = "errorbar",
                          width = 0.5)
```
　  

## 層別に描く
見やすくするために種別（`Species`）のデータを用いて層別のグラフにしてみましょう。層別に描くには`ggplot2::facet_warp`を用います。  
```{r, eval=FALSE}
# Usage
facet_wrap(facets, nrow = NULL, ncol = NULL, scales = "fixed", shrink = TRUE,
           labeller = "label_value", as.table = TRUE, switch = NULL,
           drop = TRUE, dir = "h", strip.position = "top")
```

引数`facets`は下記のようにformula形式で指定することに注意して下さい。  
```{r}
iris %>% 
  ggplot2::ggplot(ggplot2::aes(x = Sepal.Width, y = Sepal.Length,
                               colour = Species)) +
    ggplot2::geom_point() +
    ggplot2::ggtitle("みんな大好きiris") +
    ggplot2::xlab("がく片の幅") + ggplot2::ylab("がく片の長さ") +
    ggplot2::geom_smooth(method = "lm", se = TRUE) +
    ggplot2::facet_wrap(~ Species)
```
　  

## 二変数で層別に描く
二変数でマトリクス状に層別にしたい場合は`ggplot2::facet_grid`関数を用います。`mtcars`データセットを用いて車重（`wt`）と燃費（`mpg`）の関係をシリンダ数（`cyl`）とギア数（`gear`）で層別表示してみます。  
```{r, eval=FALSE}
# Usage
facet_grid(facets, margins = FALSE, scales = "fixed", space = "fixed",
           shrink = TRUE, labeller = "label_value", as.table = TRUE,
           switch = NULL, drop = TRUE)
```

```{r}
mtcars %>% 
  ggplot2::ggplot(ggplot2::aes(x = wt, y = mpg, colour = cyl)) +
    ggplot2::geom_point() +
    ggplot2::geom_smooth(method = "lm", se = TRUE) +
    ggplot2::facet_grid(gear ~ cyl)
```


## まとめ
このように`ggplot2`パッケージでは統一的な文法によりどのようなグラフも同じように描けることが分かります。加えて、色指定やグラフ装飾等も標準のグラフに比べるとてリッチです。まさに"ggplot2: Elegant Graphics for Data Analysis"。積極的に使ってみて下さい。  
紹介した以外にも`ggplot2`パッケージは時系列の折れ線グラフや棒グラフなど、様々なグラフを描くことが可能です。どのようなグラフを描けるかはヘルプはインターネットで調べてみてください。

